<link rel="stylesheet" href="/admin/styles/sales_report.css">

<!-- Report -->
<section class="section-wrapper row p-3 m-0">
  <!-- header -->
  <div class="mb-5 title-wrapper">
    <h4>Sales Report ({{total_items}})</h4>
    <div class="d-inline-flex download-btn-wrapper">
      <a href="/admin/download-report-pdf?{{json2query filter}}&limit={{page_limit}}&page={{currentPage}}&startDate={{filter.startDate}}&endDate={{filter.endDate}}" class="download-btn-pdf">
        <div class="masked-div me-1" 
					style="mask-image: url(/admin/images/icons/import.svg); --w:24px; --h:24px; --mask-bg:black;"></div>
        Download PDF
      </a>
      <a href="/admin/download-report-excel?{{json2query filter}}&limit={{page_limit}}&page={{currentPage}}&startDate={{filter.startDate}}&endDate={{filter.endDate}}" class="download-btn-excel">
        <div class="masked-div me-1" 
					style="mask-image: url(/admin/images/icons/import.svg); --w:24px; --h:24px; --mask-bg:black;"></div>
        Download EXCEL
      </a>
    </div>
  </div>
  <!-- Table -->
  <div class="table-wrapper info-box overflow-auto">
    <!-- table filter -->
    <!-- Filters -->
    <header class="orders-header p-2 border-bottom">
      <!-- search -->
      <div class="search flex-1">
        <div class="search-icon">
          <img src="/admin/images/icons/search.svg" alt="">
        </div>
        <input type="text" class="form-control" placeholder="Search">
      </div>

      <!-- Date fileter -->
      <div class="date-filter me-4">
        <span class="filter-label">From</span>
        <a class="filter-input date start-date">
          <input type="text" class="filter-prompt" readonly>
          <span class="input-group-addon cursor-pointer">
            <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/018462b45b658d6fc9d7e7e6ae6086d2177b2c2a1c8d891d191d701a49e620c9?placeholderIfAbsent=true&apiKey=4312beba142048a48d6010ff440bfdd8" alt="" class="filter-icon" />
          </span>
        </a>
        <span class="filter-label">to</span>
        <a class="filter-input date end-date">
          <input type="text" class="filter-prompt" readonly>
          <span class="input-group-addon cursor-pointer">
            <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/018462b45b658d6fc9d7e7e6ae6086d2177b2c2a1c8d891d191d701a49e620c9?placeholderIfAbsent=true&apiKey=4312beba142048a48d6010ff440bfdd8" alt="" class="filter-icon" />
          </span>
        </a>
      </div>

      <div class="filters-container">
        <div class="filter-button order-sort">
          <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/86be1cc7087c459037f23a1a8525973b5bd637b3f018b648bef0e0202506cd20?placeholderIfAbsent=true&apiKey=4312beba142048a48d6010ff440bfdd8" alt="" class="filter-icon" />
          <span class="filter-label">Sort</span>
          <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/03e7ee19e122813c19f899876a57aab2dfc33119df9ffa008ae004e95b29bc8d?placeholderIfAbsent=true&apiKey=4312beba142048a48d6010ff440bfdd8" alt="" class="filter-arrow" />
          <div class="pop-box">
            <ul class="popup-menu">
              <li class="border-bottom">
                <a href="#"><span>By date</span></a>
              </li>
              <li class="border-bottom">
                <a href="#"><span>By amount: Low to High</span></a>
              </li>
              <li>
                <a href="#"><span>By amount: High to Low</span></a>
              </li>
            </ul>
          </div>
        </div>
        <button class="filter-button order-sort" aria-haspopup="true" aria-expanded="false">
          <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/938286f7a2fbefae82347a9745ca082951967b907a09196ba5ba4900c8537499?placeholderIfAbsent=true&apiKey=4312beba142048a48d6010ff440bfdd8" alt="" class="filter-icon" />
          <span class="filter-label">Filter</span>
          <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/03e7ee19e122813c19f899876a57aab2dfc33119df9ffa008ae004e95b29bc8d?placeholderIfAbsent=true&apiKey=4312beba142048a48d6010ff440bfdd8" alt="" class="filter-arrow" />
          <ul class="popup-menu">
            <li class="border-bottom">
              <a href="/admin/sales-report?today=true">
                <input type="radio" name="report-filter" id="check-filter-none" class="me-2" 
                {{#isEmptyObject (json filter)}}
                {{#if filter.today}}checked{{/if}}
                {{else}}
                checked
                {{/isEmptyObject}}>
                <label>Today</label>
              </a>
            </li>
            <li class="border-bottom">
              <a href="/admin/sales-report?yesterday=true">
                <input type="radio" name="report-filter" id="check-filter-pending" class="me-2" {{#if filter.yesterday}}checked{{/if}}>
                <label>Yesterday</label>
              </a>
            </li>
            <li class="border-bottom">
              <a href="/admin/sales-report?thisWeek=true">
                <input type="radio" name="report-filter" id="check-filter-pending" class="me-2" {{#if filter.thisWeek}}checked{{/if}}>
                <label>This Week</label>
              </a>
            </li>
            <li class="border-bottom">
              <a href="/admin/sales-report?thisMonth=true">
                <input type="radio" name="report-filter" id="check-filter-shipped" class="me-2" {{#if filter.thisMonth}}checked{{/if}}>
                <label>This Month</label>
              </a>
            </li>
            <li class="border-bottom">
              <a href="/admin/sales-report?thisYear=true">
                <input type="radio" name="report-filter" id="check-filter-shipped" class="me-2" {{#if filter.thisYear}}checked{{/if}}>
                <label>This Year</label>
              </a>
            </li>
            <li class="border-bottom">
              <a href="/admin/sales-report?daily=true">
                <input type="radio" name="report-filter" id="check-filter-none" class="me-2" {{#if filter.daily}}checked{{/if}}>
                <label>Daily</label>
              </a>
            </li>
            <li class="border-bottom">
              <a href="/admin/sales-report?weekly=true">
                <input type="radio" name="report-filter" id="check-filter-pending" class="me-2" {{#if filter.weekly}}checked{{/if}}>
                <label>Weekly</label>
              </a>
            </li>
            <li class="border-bottom">
              <a href="/admin/sales-report?monthly=true">
                <input type="radio" name="report-filter" id="check-filter-pending" class="me-2" {{#if filter.monthly}}checked{{/if}}>
                <label>Monthly</label>
              </a>
            </li>
            <li class="border-bottom">
              <a href="/admin/sales-report?yearly=true">
                <input type="radio" name="report-filter" id="check-filter-shipped" class="me-2" {{#if filter.yearly}}checked{{/if}}>
                <label>Yearly</label>
              </a>
            </li>
          </ul>
        </button>
      </div>
    </header>

    <!-- table -->
    <table class="table">
      <thead>
        <tr>
          <th><input class="form-check-input" type="checkbox"></th>
          <th style="--w:100px">Order</th>
          <th style="--w:150px">Customer</th>
          <th style="--w:100px">Products</th>
          <th style="--w:100px">Tax</th>
          <th style="--w:100px">Discounts</th>
          <th style="--w:100px">Total</th>
          <th style="--w:100px">Payment</th>
          <th style="--w:100px" class="text-center">Status</th>
        </tr>
      </thead>
      <tbody>
        {{#each report}}
          <tr>
            <td><input class="form-check-input" type="checkbox"></td>
            <td style="--w:100px" class="text-nowrap">
              <div class="d-flex flex-column">
                <span>{{this.order_no}}</span>
                <span>{{this.date}}</span>
              </div>
            </td>
            <td style="--w:150px"><span>{{this.customer}}</span></td>
            <td style="--w:100px" class="justify-content-center"><span>{{this.quantity}}</span></td>
            <td style="--w:100px"><span class="price">{{this.tax}}</span></td>
            <td style="--w:100px"><span class="price">{{this.discounts}}</span></td>
            <td style="--w:100px"><span class="price">{{this.order_total}}</span></td>
            <td style="--w:100px"><span>{{this.payment_method}}</span></td>
            <td style="--w:100px" class="text-end"><span>{{this.order_status}}</span></td>
          </tr>
        {{/each}}
      </tbody>
    </table>

    <!-- pagination -->
    <div class="pagination-wrapper">
      <div class="status-report">
        <span>
          {{#if filter.today}}Today's Report
          {{else if filter.yesterday}}Yesterday's Report
          {{else if filter.thisWeek}}This Week Report
          {{else if filter.thisMonth}}This Month Report
          {{else if filter.thisYear}}This Year Report
          {{else if filter.daily}}Daily Report
          {{else if filter.weekly}}Weekly Report
          {{else if filter.monthly}}Monthly Report
          {{else if filter.yearly}}Yearly Report
          {{else if filter.custom}}Custom Date Report
          {{else}}Today's Report
          {{/if}}
        </span>
        <span class="devider"></span>
        <p class="m-0 fw-bold me-2">Over All</p>
        <span><span class="text-black-50">Sold Items:</span><span class="ms-1"> {{total.sold_items}}</span></span>
        <span class="devider"></span>
        <span><span class="text-black-50">Discounts:</span><span class="price ms-1"> {{total.discounts}}</span></span>
        <span class="devider"></span>
        <span><span class="text-black-50">Sales:</span><span class="price ms-1"> {{total.revenue}}</span></span>
        <span class="devider"></span>
        <span><span class="text-black-50">Orders:</span><span> {{total.count}}</span></span>
        
      </div>
      
      <div class="paginations">
        <span class="me-2">Rows per page:</span>
        <form id="limit-form" method="get" class="d-inline-flex">
          <select class="me-4" name="limit" id="limitSelect">
            <option value="5" {{#if (eq page_limit 5)}} selected {{/if}}>5</option>
            <option value="10"{{#if (eq page_limit 10)}} selected {{/if}}>10</option>
            <option value="15"{{#if (eq page_limit 15)}} selected {{/if}}>15</option>
            <option value="20"{{#if (eq page_limit 20)}} selected {{/if}}>20</option>
          </select>
        </form>
        <span class="me-5">{{currentPage}} / {{totalPages}}</span>
        <a class="cursor-pointer me-3 previous">
          <i class="las la-angle-left"></i>
        </a>
        <a class="cursor-pointer next">
          <i class="las la-angle-right"></i>
        </a>
      </div>
    </div>
  </div>
</section>

<script>

  $( ".date" ).datepicker({
    format: "dd-mm-yyyy",
    orientation: "bottom left",
  });

  $('.start-date').datepicker('setDate', '{{filter.startDate}}' ? '{{filter.startDate}}' : new Date())
  $('.end-date').datepicker('setDate', '{{filter.endDate}}' ? '{{filter.endDate}}' : new Date())

  $('.start-date').on('changeDate',function(e){
    
    if(new Date(e.date) < convertedDate($('.date.end-date > input').val())){
      const url = `/admin/sales-report?custom=true&startDate=${new Date(e.date).toLocaleDateString().replaceAll('/','-')}&endDate=${$('.date.end-date > input').val()}`
      window.location.href = url
    }else{
      if(new Date(e.date).setHours(0,0,0,0) > convertedDate($('.date.end-date > input').val())){
        Swal.fire({
          title: 'Invalid Date Range',
          text: 'Start date should be less than or equal to end date',
          icon: 'error',
          confirmButtonText: 'Okay'
        }).then(() => {
          $(this).datepicker('setDate',new Date())
          dateReset = true;
        })
      }
    }

  })

  $('.end-date').on('changeDate',function(e){

    if(new Date(e.date) > convertedDate($('.date.start-date > input').val())){
      const url = `/admin/sales-report?custom=true&endtDate=${new Date(e.date).toLocaleDateString().replaceAll('/','-')}&startDate=${$('.date.start-date > input').val()}`
      window.location.href = url
    }else{
    
      if(new Date(e.date).setHours(0,0,0,0) < convertedDate($('.date.start-date > input').val())){
        Swal.fire({
          title: 'Invalid Date Range',
          text: 'End date should be greater than or equal to start date',
          icon: 'error',
          confirmButtonText: 'Okay'
        }).then(() => {
          $(this).datepicker('setDate',new Date())
          dateReset = true;
        })
      }
      
    }
  })

  function convertedDate(date){
    const [day, month, year] = date.split('-');
    return new Date(year, month-1, day).setHours(0,0,0,0);
  }

  const currentPage = {{currentPage}}
  const totalPages = {{totalPages}}
  const filter = {{{json filter}}}

  $('.previous').on('click',function(){
    if(currentPage > 1){
      const url = `/admin/sales-report?{{{json2query filter}}}&page=${currentPage - 1}&skip={{skip}}&limit={{page_limit}}`
      window.location.href = url
    }
  })

  $('.next').on( 'click',function(){
    if(currentPage < totalPages){
      const url = `/admin/sales-report?{{{json2query filter}}}&page=${currentPage + 1}&skip={{skip}}&limit={{page_limit}}`
      window.location.href = url
    }
  })

  // limit selector handling
  $('#limitSelect').on('change', function (){
    const url = `/admin/sales-report?{{{json2query filter}}}&page=${currentPage}&skip={{skip}}&limit=${$(this).val()}`
    window.location.href = url
  })

</script>